<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Estimation Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input[type="text"], input[type="number"] {
            transition: border-color 0.2s ease;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        table input {
            border: 1px solid transparent;
            background: transparent;
        }
        table input:hover {
            border-color: #e5e7eb;
            background: white;
        }
        table input:focus {
            border-color: #3b82f6;
            background: white;
        }
        .toast {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üìä Project Estimation Tracker</h1>
                <div class="flex gap-3">
                    <button onclick="loadLatestData()" class="btn flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        üì• Load Latest
                    </button>
                    <button onclick="appendToMaster()" class="btn flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        üíæ Save to DB
                    </button>
                    <button onclick="createNewMaster()" class="btn flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        üìÑ New DB File
                    </button>
                </div>
            </div>

            <!-- Toast Message -->
            <div id="toast" class="hidden mb-4 p-3 rounded-lg"></div>

            <!-- Database File Path -->
            <div class="mb-6 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                    üìÅ Database File Configuration
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Database File Name</label>
                        <input
                            type="text"
                            id="dbFileName"
                            value="Project_Estimation_Master.xlsx"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md"
                            placeholder="Enter database file name"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Database File</label>
                        <input
                            type="file"
                            id="dbFileInput"
                            accept=".xlsx,.xls"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"
                        />
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    üí° <strong>Tip:</strong> Use the file selector to locate your existing database file, or specify a new name to create one.
                </p>
            </div>

            <!-- Project Information -->
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Project Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">JIRA ID</label>
                    <input type="text" id="jiraId" value="JIRACEN-5565" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SR Number</label>
                    <input type="text" id="srNumber" value="SR3-41299221001" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estimation Date</label>
                    <input type="text" id="estimationDate" value="04-Sep-25" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Approved Date</label>
                    <input type="text" id="approvedDate" value="" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ticket Owner</label>
                    <input type="text" id="ticketOwner" value="Audrey" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Functional</label>
                    <input type="text" id="functional" value="" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">OIC Resources</label>
                    <input type="text" id="oicResources" value="Rashmi" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CSU</label>
                    <input type="text" id="csu" value="24" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>

            <!-- Activities Table -->
            <div class="overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Activities</h2>
                    <button onclick="addActivity()" class="btn flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        ‚ûï Add Activity
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse" id="activitiesTable">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Step</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Detail</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Owner</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Count</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Est. Hrs</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Act. Hrs</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Complexity</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Remarks</th>
                                <th class="border border-gray-300 px-3 py-2 text-center text-sm font-semibold">Action</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesBody">
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 font-semibold">
                                <td colspan="4" class="border border-gray-300 px-3 py-2 text-right">TOTAL:</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm" id="totalEstimated">0 hrs</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm" id="totalActual">0 hrs</td>
                                <td colspan="3" class="border border-gray-300"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Instructions -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-2">üìù How to Use:</h3>
                <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                    <li><strong>First Time:</strong> Click "New DB File" to create your Excel database file</li>
                    <li><strong>Specify Location:</strong> Use the file selector to choose where your database file is located</li>
                    <li><strong>Add/Edit Data:</strong> Make changes to project info and activities</li>
                    <li><strong>Save to DB:</strong> Click "Save to DB" - your data is added as a new sheet with timestamp</li>
                    <li><strong>Load Latest:</strong> Click "Load Latest" to retrieve the most recent data from your database</li>
                </ol>
                <div class="mt-3 p-3 bg-white rounded border border-blue-200">
                    <p class="text-sm text-gray-600">üí° <strong>Note:</strong> Each save creates a new sheet in the same Excel file, maintaining complete history!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial activities data
        let activities = [
            { step: 1, detail: 'Backlog Grooming / Requirement Gathering', owner: 'ACS', activityCount: 1, estimatedTime: 1, actualTime: '', complexity: '', remarks: '' },
            { step: 2, detail: 'Design Review Doc Preparation', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 3, detail: 'Design Review Session', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 4, detail: 'Design Signoff - (SCOPE FREEZE)', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 5, detail: 'QA Session (Test Scenarios Discussion)', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 6, detail: 'Agreed Test Case Summary preparation', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 7, detail: 'Test Summary Freeze', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 8, detail: 'Agreed Env for DEV work', owner: 'DEV-OIC', activityCount: '', estimatedTime: '', actualTime: '', complexity: '', remarks: '' },
            { step: 9, detail: 'Actual Development', owner: '', activityCount: 15, estimatedTime: 6, actualTime: '', complexity: 'COMPLEX', remarks: '' },
            { step: 10, detail: 'Test Scenario Execution - Developers Unit Testing', owner: '', activityCount: 1, estimatedTime: 10, actualTime: '', complexity: 'COMPLEX', remarks: 'Recording Based' },
            { step: 11, detail: 'Test Scenario Execution - Functional', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 12, detail: 'Internal Peer Review', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 13, detail: 'OML Peer Review Call', owner: '', activityCount: 1, estimatedTime: 1, actualTime: '', complexity: '', remarks: 'OML owns UAT' },
            { step: 14, detail: 'Peer Review - (document changes)', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 15, detail: 'Peer Review - Implementations and testing changes', owner: '', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 16, detail: 'Testing - Functional (Business/OML IT)', owner: 'OML', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: '', remarks: '' },
            { step: 17, detail: 'Code Migration Doc, Change Template, TDD, etc', owner: 'ACS (OIC)', activityCount: 1, estimatedTime: 1, actualTime: '', complexity: 'Simple', remarks: 'Code Deployment Doc' },
            { step: 18, detail: 'Code Movement to Test', owner: 'ACS (OIC)', activityCount: 1, estimatedTime: 1, actualTime: '', complexity: '', remarks: '' },
            { step: 19, detail: 'Change Request to PROD', owner: 'ACS (OIC)', activityCount: 0, estimatedTime: 0, actualTime: '', complexity: 'Simple', remarks: '' },
            { step: 20, detail: 'Post Production', owner: '', activityCount: 1, estimatedTime: 1, actualTime: '', complexity: '', remarks: '' }
        ];

        // Store the loaded workbook for appending
        let currentWorkbook = null;

        // Initialize the table
        function renderActivities() {
            const tbody = document.getElementById('activitiesBody');
            tbody.innerHTML = '';
            
            activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-3 py-2 text-sm">${activity.step}</td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" value="${activity.detail}" onchange="updateActivity(${index}, 'detail', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" value="${activity.owner}" onchange="updateActivity(${index}, 'owner', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="number" value="${activity.activityCount}" onchange="updateActivity(${index}, 'activityCount', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="number" value="${activity.estimatedTime}" onchange="updateActivity(${index}, 'estimatedTime', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="number" value="${activity.actualTime}" onchange="updateActivity(${index}, 'actualTime', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" value="${activity.complexity}" onchange="updateActivity(${index}, 'complexity', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" value="${activity.remarks}" onchange="updateActivity(${index}, 'remarks', this.value)" 
                               class="w-full px-2 py-1 text-sm rounded">
                    </td>
                    <td class="border border-gray-300 px-3 py-2 text-center">
                        <button onclick="deleteActivity(${index})" class="text-red-600 hover:text-red-800 text-xl">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateTotals();
        }

        function updateActivity(index, field, value) {
            activities[index][field] = value;
            updateTotals();
        }

        function updateTotals() {
            const totalEst = activities.reduce((sum, a) => sum + (Number(a.estimatedTime) || 0), 0);
            const totalAct = activities.reduce((sum, a) => sum + (Number(a.actualTime) || 0), 0);
            document.getElementById('totalEstimated').textContent = totalEst + ' hrs';
            document.getElementById('totalActual').textContent = totalAct + ' hrs';
        }

        function addActivity() {
            const newStep = activities.length + 1;
            activities.push({
                step: newStep,
                detail: '',
                owner: '',
                activityCount: 0,
                estimatedTime: 0,
                actualTime: '',
                complexity: '',
                remarks: ''
            });
            renderActivities();
        }

        function deleteActivity(index) {
            activities.splice(index, 1);
            // Renumber steps
            activities.forEach((activity, i) => {
                activity.step = i + 1;
            });
            renderActivities();
        }

        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.className = `toast mb-4 p-3 rounded-lg ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function getProjectInfo() {
            return {
                jiraId: document.getElementById('jiraId').value,
                srNumber: document.getElementById('srNumber').value,
                estimationDate: document.getElementById('estimationDate').value,
                approvedDate: document.getElementById('approvedDate').value,
                ticketOwner: document.getElementById('ticketOwner').value,
                functional: document.getElementById('functional').value,
                oicResources: document.getElementById('oicResources').value,
                csu: document.getElementById('csu').value
            };
        }

        function setProjectInfo(info) {
            document.getElementById('jiraId').value = info.jiraId || '';
            document.getElementById('srNumber').value = info.srNumber || '';
            document.getElementById('estimationDate').value = info.estimationDate || '';
            document.getElementById('approvedDate').value = info.approvedDate || '';
            document.getElementById('ticketOwner').value = info.ticketOwner || '';
            document.getElementById('functional').value = info.functional || '';
            document.getElementById('oicResources').value = info.oicResources || '';
            document.getElementById('csu').value = info.csu || '';
        }

        function createDataSheet() {
            const projectInfo = getProjectInfo();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const sheetName = `${projectInfo.jiraId}_${timestamp}`.substring(0, 31);

            const projectData = [
                ['Project Estimation Tracker'],
                ['Last Updated: ' + new Date().toLocaleString()],
                [],
                ['JIRA ID', projectInfo.jiraId],
                ['SR Number', projectInfo.srNumber],
                ['Estimation Date', projectInfo.estimationDate],
                ['Approved Date', projectInfo.approvedDate],
                ['Ticket Owner', projectInfo.ticketOwner],
                ['Functional', projectInfo.functional],
                ['OIC Resources', projectInfo.oicResources],
                ['CSU', projectInfo.csu],
                []
            ];

            const activitiesData = [
                ['Step', 'Detail', 'Owner', 'Activity Count', 'Estimated Time (hrs)', 'Actual Time (hrs)', 'Complexity', 'Remarks']
            ];

            activities.forEach(activity => {
                activitiesData.push([
                    activity.step,
                    activity.detail,
                    activity.owner,
                    activity.activityCount,
                    activity.estimatedTime,
                    activity.actualTime,
                    activity.complexity,
                    activity.remarks
                ]);
            });

            const totalEstimated = activities.reduce((sum, a) => sum + (Number(a.estimatedTime) || 0), 0);
            const totalActual = activities.reduce((sum, a) => sum + (Number(a.actualTime) || 0), 0);
            
            activitiesData.push([]);
            activitiesData.push(['', '', '', 'TOTAL', totalEstimated, totalActual, '', '']);

            const allData = [...projectData, ...activitiesData];
            const ws = XLSX.utils.aoa_to_sheet(allData);
            
            ws['!cols'] = [
                { wch: 8 },
                { wch: 50 },
                { wch: 15 },
                { wch: 15 },
                { wch: 20 },
                { wch: 18 },
                { wch: 12 },
                { wch: 40 }
            ];

            return { sheetName, worksheet: ws };
        }

        function createNewMaster() {
            const wb = XLSX.utils.book_new();
            const { sheetName, worksheet } = createDataSheet();
            XLSX.utils.book_append_sheet(wb, worksheet, sheetName);
            
            const fileName = document.getElementById('dbFileName').value;
            XLSX.writeFile(wb, fileName);
            
            showToast(`‚úì New database file created: ${fileName}`);
        }

        function appendToMaster() {
            const fileInput = document.getElementById('dbFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showToast('‚ö†Ô∏è Please select your database file first', false);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    
                    const { sheetName, worksheet } = createDataSheet();
                    XLSX.utils.book_append_sheet(wb, worksheet, sheetName);
                    
                    const fileName = document.getElementById('dbFileName').value;
                    XLSX.writeFile(wb, fileName);
                    
                    showToast(`‚úì Data saved to ${fileName} as sheet: ${sheetName}`);
                } catch (error) {
                    showToast('‚úó Error updating database file: ' + error.message, false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadLatestData() {
            const fileInput = document.getElementById('dbFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showToast('‚ö†Ô∏è Please select your database file first', false);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const lastSheetName = workbook.SheetNames[workbook.SheetNames.length - 1];
                    const worksheet = workbook.Sheets[lastSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    let projectInfoStartRow = 0;
                    for (let i = 0; i < jsonData.length; i++) {
                        if (jsonData[i][0] === 'JIRA ID') {
                            projectInfoStartRow = i;
                            break;
                        }
                    }

                    const projectInfo = {
                        jiraId: jsonData[projectInfoStartRow]?.[1] || '',
                        srNumber: jsonData[projectInfoStartRow + 1]?.[1] || '',
                        estimationDate: jsonData[projectInfoStartRow + 2]?.[1] || '',
                        approvedDate: jsonData[projectInfoStartRow + 3]?.[1] || '',
                        ticketOwner: jsonData[projectInfoStartRow + 4]?.[1] || '',
                        functional: jsonData[projectInfoStartRow + 5]?.[1] || '',
                        oicResources: jsonData[projectInfoStartRow + 6]?.[1] || '',
                        csu: jsonData[projectInfoStartRow + 7]?.[1] || ''
                    };
                    setProjectInfo(projectInfo);

                    let activitiesHeaderRow = 0;
                    for (let i = projectInfoStartRow; i < jsonData.length; i++) {
                        if (jsonData[i][0] === 'Step') {
                            activitiesHeaderRow = i;
                            break;
                        }
                    }

                    const newActivities = [];
                    for (let i = activitiesHeaderRow + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0 || row[0] === '' || row[3] === 'TOTAL') break;
                        
                        newActivities.push({
                            step: row[0] || newActivities.length + 1,
                            detail: row[1] || '',
                            owner: row[2] || '',
                            activityCount: row[3] || 0,
                            estimatedTime: row[4] || 0,
                            actualTime: row[5] || '',
                            complexity: row[6] || '',
                            remarks: row[7] || ''
                        });
                    }
                    
                    if (newActivities.length > 0) {
                        activities = newActivities;
                        renderActivities();
                    }

                    showToast(`‚úì Data loaded from sheet: ${lastSheetName}`);
                } catch (error) {
                    showToast('‚úó Error loading data: ' + error.message, false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Initialize on page load
        renderActivities();
    </script>
</body>
</html>